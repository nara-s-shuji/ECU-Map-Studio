<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>ECU Map Studio 2026</title>
    <!-- Offline Plotly Library -->
    <script src="lib/plotly.min.js"></script>
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/style.css?v=2.0">
</head>

<body>

    <div id="toolbar">
        <button class="toolbar-btn" data-tooltip="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã (Ctrl+O)" onclick="openFile()">ğŸ“</button>
        <button class="toolbar-btn" data-tooltip="åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã (Ctrl+Shift+O)" onclick="openBaseFile()">ğŸ“‹</button>
        <button class="toolbar-btn" data-tooltip="ä¿å­˜ (Ctrl+S)" onclick="saveFile()">ğŸ’¾</button>

        <div class="toolbar-separator"></div>

        <button class="toolbar-btn" data-tooltip="å…ƒã«æˆ»ã™ (Ctrl+Z)" onclick="undo()" id="btn-undo">â†¶</button>
        <button class="toolbar-btn" data-tooltip="ã‚„ã‚Šç›´ã— (Ctrl+Y)" onclick="redo()" id="btn-redo">â†·</button>

        <div class="toolbar-separator"></div>

        <button class="toolbar-btn ecu-disconnected" data-tooltip="ECUã«æ¥ç¶š" onclick="toggleECUConnection()"
            id="btn-ecu-connect">
            <!-- WiFi + ECU Icon -->
            <svg viewBox="0 0 24 24" class="icon-svg">
                <!-- WiFi Arcs -->
                <path
                    d="M12 3c4.284 0 8.232 1.452 11.416 3.96l-1.632 2.04C19.124 7.02 15.732 5.76 12 5.76c-3.744 0-7.14 1.26-9.784 3.24L0.584 6.96C3.768 4.452 7.716 3 12 3z"
                    fill="currentColor" />
                <path
                    d="M12 7.8c3.084 0 5.928 1.044 8.22 2.844l-1.632 2.04C16.92 11.4 14.568 10.56 12 10.56c-2.58 0-4.932 0.84-6.588 2.124l-1.632-2.04C6.072 8.844 8.916 7.8 12 7.8z"
                    fill="currentColor" />
                <!-- ECU Box below -->
                <path d="M6 14h12v7c0 1.1-0.9 2-2 2H8c-1.1 0-2-0.9-2-2v-7z" fill="currentColor" />
                <rect x="7" y="16" width="3" height="4" fill="var(--bg)" />
                <rect x="11" y="16" width="1" height="4" fill="var(--bg)" />
                <rect x="13" y="16" width="1" height="4" fill="var(--bg)" />
                <rect x="15" y="16" width="2" height="1" fill="var(--bg)" />
                <rect x="15" y="18" width="2" height="1" fill="var(--bg)" />
            </svg>
        </button>
        <button class="toolbar-btn" data-tooltip="ECUã«æ›¸ãè¾¼ã¿ (Ctrl+W)" onclick="writeToECU()" id="btn-write"
            disabled>ğŸ“¤</button>
        <button class="toolbar-btn" data-tooltip="ECUã‹ã‚‰èª­ã¿å–ã‚Š (Ctrl+R)" onclick="readFromECU()" id="btn-read"
            disabled>ğŸ“¥</button>

        <div class="toolbar-separator"></div>

        <button class="toolbar-btn" data-tooltip="ã‚°ãƒ©ãƒ•è¡¨ç¤º (Ctrl+G)" onclick="toggleGraph()" id="btn-graph">ğŸ“Š</button>

        <span class="toolbar-title">ECU Map Studio - Kitaco S3 v1.0</span>
        <button class="hamburger-menu" onclick="toggleSettings()" id="btn-settings">â˜°</button>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ãƒ“ãƒ¥ãƒ¼ -->
    <div id="editor-view" class="view-section active">
        <div id="info-section">
            <div class="info-item">
                <span class="info-label">Selected:</span>
                <span class="info-value" id="info-cell">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Value:</span>
                <span class="info-value" id="info-value">-</span>
            </div>
            <div class="info-item">
                <span class="info-label" style="color: #0078d4;">Original:</span>
                <span class="info-value" id="info-original">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Change:</span>
                <span class="info-value" id="info-change">-</span>
                <span class="info-value" id="info-change-percent" style="font-size: 0.8em; color: #888;"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Range:</span>
                <span class="info-value" id="info-range">-</span>
            </div>
        </div>

        <div id="map-section">
            <div id="map-container">
                <div class="header-row" id="headerRow"></div>
                <!-- Grid will be populated by JS -->
                <div class="map-grid" id="mapGrid"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ‹ã‚¿ãƒ¼ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ -->
    <div id="monitor-view" class="view-section" style="display:none; padding: 20px; text-align: center; color: #888;">
        <h2>ğŸ“Š Monitor Mode</h2>
        <p>Coming Soon...</p>
        <p>Real-time gauges and meters will appear here.</p>
    </div>

    <!-- ãƒ­ã‚¬ãƒ¼ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ -->
    <div id="logger-view" class="view-section" style="display:none; padding: 20px; text-align: center; color: #888;">
        <h2>ğŸ’¾ Data Logger</h2>
        <p>Coming Soon...</p>
        <p>Log recording and playback features will appear here.</p>
    </div>

    <div id="settings-menu">
        <h3>âš™ï¸ è¨­å®š</h3>
        <div class="setting-item">
            <label>ã‚»ãƒ«æ•°å€¤ã®è‰²è¡¨ç¤º:</label>
            <select id="cell-color-mode" onchange="updateCellColorMode()">
                <option value="diff">å·®åˆ†è¡¨ç¤ºï¼ˆç·¨é›†: èµ¤/é’ï¼‰</option>
                <option value="heatmap">ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆé’â†’ç·‘â†’èµ¤ï¼‰</option>
            </select>
        </div>
    </div>

    <div id="graph-overlay">
        <div id="graph-header">
            <select id="graph-type" onchange="updateGraph()">
                <option value="3d">3D: Surface</option>
                <option value="rpm">2D: vs RPM (Fix TPS)</option>
                <option value="tps">2D: vs TPS (Fix RPM)</option>
            </select>
            <button id="graph-close" onclick="toggleGraph()">Ã—</button>
        </div>
        <div id="graph-body">
            <div id="chart-container"></div>
        </div>

        <div class="resize-handle resize-n"
            style="position: absolute; top: 0; left: 0; right: 0; height: 15px; cursor: ns-resize; z-index: 999999;">
        </div>
        <div class="resize-handle resize-s"
            style="position: absolute; bottom: 0; left: 0; right: 0; height: 15px; cursor: ns-resize; z-index: 999999;">
        </div>
        <div class="resize-handle resize-e"
            style="position: absolute; right: 0; top: 0; bottom: 0; width: 15px; cursor: ew-resize; z-index: 999999;">
        </div>
        <div class="resize-handle resize-w"
            style="position: absolute; left: 0; top: 0; bottom: 0; width: 15px; cursor: ew-resize; z-index: 999999;">
        </div>
        <div class="resize-handle resize-ne"
            style="position: absolute; top: 0; right: 0; width: 25px; height: 25px; cursor: nesw-resize; z-index: 999999;">
        </div>
        <div class="resize-handle resize-nw"
            style="position: absolute; top: 0; left: 0; width: 25px; height: 25px; cursor: nwse-resize; z-index: 999999;">
        </div>
        <div class="resize-handle resize-se"
            style="position: absolute; bottom: 0; right: 0; width: 25px; height: 25px; cursor: nwse-resize; z-index: 999999;">
        </div>
        <div class="resize-handle resize-sw"
            style="position: absolute; bottom: 0; left: 0; width: 25px; height: 25px; cursor: nesw-resize; z-index: 999999;">
        </div>
    </div>

    <input type="file" id="file-input" style="display:none" onchange="importFromCSV(this)">
    <input type="file" id="base-file-input" style="display:none" onchange="importBaseFromCSV(this)">

    <!-- ã‚»ãƒ«ç·¨é›†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="cell-popup">
        <div class="popup-mode-selector">
            <button class="popup-mode-btn active" id="mode-abs" onclick="switchPopupMode('abs')">çµ¶å¯¾å€¤</button>
            <button class="popup-mode-btn" id="mode-pct" onclick="switchPopupMode('pct')">%</button>
        </div>
        <div class="popup-controls">
            <button class="popup-btn" onmousedown="startAdjusting(-1)" onmouseup="stopAdjusting()"
                onmouseleave="stopAdjusting()" ontouchstart="startAdjusting(-1)" ontouchend="stopAdjusting()">â–½</button>
            <input type="number" class="popup-input" id="popup-delta" value="10" step="1" min="1">
            <button class="popup-btn" onmousedown="startAdjusting(1)" onmouseup="stopAdjusting()"
                onmouseleave="stopAdjusting()" ontouchstart="startAdjusting(1)" ontouchend="stopAdjusting()">â–³</button>
        </div>
    </div>

    <div id="main-container">
        <div id="explorer">
            <div class="explorer-header">EXPLORER: PROJECT</div>
            <div class="tree-item"><span class="tree-icon">ğŸ“</span> src</div>
            <div class="tree-item active"><span class="tree-icon">ğŸ“Š</span> Main_Fuel_Map.csv</div>
            <div class="tree-item"><span class="tree-icon">ğŸ“Š</span> Ignition_Map.csv</div>
            <div class="tree-item"><span class="tree-icon">ğŸ“Š</span> Idling_Correction.csv</div>
            <div class="tree-item"><span class="tree-icon">âš™ï¸</span> Settings.json</div>

            <div class="explorer-header" style="margin-top:20px;">ACTIONS</div>
            <div style="padding: 0 10px;">
                <p style="font-size: 10px; color: #666; margin: 10px 0;">ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã¯ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„</p>
            </div>
        </div>

        <div id="content-area">
            <div id="map-section">
                <div id="table-wrapper">
                    <div id="headerRow" class="header-row"></div>
                    <div id="mapGrid" class="grid-container"></div>
                </div>
            </div>

            <div id="info-section">
                <h3>ğŸ“‹ Information</h3>
                <div id="info-content">
                    <p style="margin: 5px 0;"><strong>Selected Cell:</strong> <span id="info-cell">-</span></p>
                    <p style="margin: 5px 0;"><strong>Current Value:</strong> <span id="info-value">-</span> Î¼s</p>
                    <p style="margin: 5px 0;"><strong>Original Value:</strong> <span id="info-original">-</span> Î¼s</p>
                    <p style="margin: 5px 0;"><strong>Change:</strong> <span id="info-change">-</span> (<span
                            id="info-change-percent">-</span>)</p>
                    <p style="margin: 5px 0;"><strong>Map Range:</strong> <span id="info-range">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/app.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/map.js"></script>
    <script src="js/graph.js"></script>

</body>

</html>